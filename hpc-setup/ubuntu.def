Bootstrap: docker
From: ubuntu:20.04

%runscript
    #!/bin/bash
    
    echo "OMNet++ installation dir: $INSTALLATION_DIR_OMNETPP"
    echo "SUMO installation dir: $INSTALLATION_DIR_SUMO"
    
    export INSTALLATION_DIR_OMNETPP INSTALLATION_DIR_SUMO
    
    PATH="$PATH:$INSTALLATION_DIR_OMNETPP/omnetpp-5.7/bin"
    PATH="$PATH:$INSTALLATION_DIR_SUMO/sumo-1.8.0/bin"
    export PATH

    echo "Invoked inside the container in runtime."
    
    MNT="/mnt"
    REPO_MNT="$MNT/MasterThesis"

    if [ -d "$MNT" ];
    then
        echo "$MNT directory found, proceeding."
    else
	    echo "Run the container with --bind <host dir>:$MNT:rw to bind a directory."
	    exit -1
    fi 
    
    # Copying the repository to RW directory
    if [ ! -d $REPO_MNT/.git ]
    then
        echo "Copying repository from RO partition...\n"        
        cp -R /MasterThesis $MNT
        if [ $? != 0 ]; then exit $?; fi
    fi
    
    cd "$REPO_MNT"
    git pull
    if [ $? != 0 ]; then exit $?; fi
    
    echo "Container's PATH: $PATH"
    echo "Container's SUMO_HOME: $SUMO_HOME" 
    
    # Building 
    cd $REPO_MNT/drones_veins_project
    if [ $? != 0 ]; then exit $?; fi
    
    echo "Calling setenv..."
    . ./setenv
    if [ $? != 0 ]; then exit $?; fi
    echo "Calling configure..."
    ./configure
    if [ $? != 0 ]; then exit $?; fi
    
    echo "Making..."
    mkdir -p veins/bin
    mkdir -p drones_veins_project/bin
    make -j8
    if [ $? != 0 ]; then exit $?; fi
    
    cd $REPO_MNT/stats
    echo "Simulating..."
    . ./setvars_runtime.sh
    . ./run-stats.sh -r
    
%environment    
    INSTALLATION_DIR_OMNETPP="/Software"
    INSTALLATION_DIR_SUMO="/Software"
    export INSTALLATION_DIR_OMNETPP INSTALLATION_DIR_SUMO
    
    PATH="$PATH:$INSTALLATION_DIR_OMNETPP/omnetpp-5.7/bin"
    PATH="$PATH:$INSTALLATION_DIR_SUMO/sumo-1.8.0/bin"
    export PATH
%post
    #!/bin/bash
    
    if [ -z $INSTALLATION_DIR_OMNETPP ]
    then
        echo "OMNeT++ installation dir not set"
        $INSTALLATION_DIR_OMNETPP="/Software"
    fi
    
    if [ -z $INSTALLATION_DIR_SUMO ]
    then
        echo "SUMO installation dir not set"
        $INSTALLATION_DIR_SUMO="/Software"
    fi
    
    echo "Invoked inside the container in buildtime\n"
    apt-get update
    echo ""
    
    ln -fs /usr/share/zoneinfo/Europe/Berlin /etc/localtime
    export DEBIAN_FRONTEND=noninteractive
    apt-get install -y tzdata
    dpkg-reconfigure --frontend noninteractive tzdata
    
    echo "Installing git...\n"
    apt-get -y install git
    echo ""
    
    if [ ! -d /MasterThesis/.git ]
    then
        echo "Cloning repository...\n"        
        git clone https://DmitryMI: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@github.com/DmitryMI/MasterThesis
    echo ""
    else
        echo "Singularity repository already exists in $(pwd). Pulling..."
        cd /MasterThesis
        git pull
    fi

    echo "Running installation scripts...\n"
    cd /MasterThesis/software-installation
    echo "#!/bin/bash" > ./_executor.sh
    echo "INSTALLATION_DIR_OMNETPP=\"${INSTALLATION_DIR_OMNETPP}\"" >> ./_executor.sh
    echo "INSTALLATION_DIR_SUMO=\"${INSTALLATION_DIR_SUMO}\"" >> ./_executor.sh
    echo "source setvars_runtime.sh" >> ./_executor.sh
    echo "source install_all.sh" >> ./_executor.sh
    chmod +x ./_executor.sh
    ls -al
    ./_executor.sh
    echo ""
    
    apt-get -y autoremove
    apt-get -y clean
    apt-get -y autoclean
    
    
